name: CI Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:

jobs:
  lint-and-docs:
    name: Lint with ESLint and Prettier
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Dependencies
        run: npm ci
      - name: Run ESLint
        run: npm run lint
      - name: Run Prettier
        run: npm run format -- --check
      - name: Generate JSDoc
        if: success()
        run: npx jsdoc -c jsdoc.json
      - name: Convert README to index.html
        run: |
          mkdir -p public
          npx marked README.md > public/index.html
      - name: Copy other HTML pages
        run: cp *.html public/
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public

  validate-html:
    name: Validate HTML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get install -y jq
      - name: Validate HTML files using W3C API
        run: |
          failed=0
          for file in ./*.html; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              response=$(curl -s -H "Content-Type: text/html; charset=utf-8" --data-binary "@$file" "https://validator.w3.org/nu/?out=json")
              messages=$(echo "$response" | jq '.messages | length')
              if [ "$messages" -eq 0 ]; then
                echo "✅ $file is valid"
              else
                echo "❌ $file has $messages issue(s):"
                echo "$response" | jq -r '.messages[] | "- [\(.type)] \(.message) at line \(.lastLine // "unknown")"'
                failed=1
              fi
            fi
          done
          exit $failed

  tests:
    name: Unit Tests with Jest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Dependencies
        run: npm ci
      - name: Run all tests
        run: npm test
